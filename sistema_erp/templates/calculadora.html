{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h3 class="fw-bold mb-4"><i class="fa-solid fa-calculator me-2"></i> Calculadora de Precifica칞칚o</h3>

    <div class="row">
        <div class="col-lg-5">
            <div class="calc-card p-4 h-100">
                
                <div class="d-flex justify-content-center mb-4">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="btnradio" id="mode-db" autocomplete="off" checked onchange="toggleMode('db')">
                        <label class="btn btn-outline-primary fw-bold" for="mode-db">游닍 Produto Existente</label>
                      
                        <input type="radio" class="btn-check" name="btnradio" id="mode-sim" autocomplete="off" onchange="toggleMode('sim')">
                        <label class="btn btn-outline-success fw-bold" for="mode-sim">游빍 Simular Novo</label>
                    </div>
                </div>

                <div id="container-db" class="mb-3">
                    <label class="small fw-bold text-muted mb-1">Buscar Produto</label>
                    <select id="selectProduto" class="form-select">
                        <option value="">Digite SKU ou Nome...</option>
                        {% for p in produtos %}
                        <option value="{{ p.id }}">{{ p.sku }} - {{ p.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="container-sim" class="mb-3 p-3 bg-panel rounded border border-success border-opacity-25" style="display:none;">
                    <h6 class="text-success fw-bold small mb-3"><i class="fa-solid fa-flask"></i> Dados da Compra (Simula칞칚o)</h6>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input sim-input" type="checkbox" id="sim-lucro-real">
                            <label class="form-check-label small" for="sim-lucro-real">Lucro Real?</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sim-importacao" onchange="atualizarTaxasSimulacao()">
                            <label class="form-check-label small fw-bold text-primary" for="sim-importacao">Importa칞칚o?</label>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small text-muted">Pre칞o Nota</label>
                            <input type="number" id="sim-preco" class="form-control form-control-sm sim-input" placeholder="0.00">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Frete Rateio</label>
                            <input type="number" id="sim-frete" class="form-control form-control-sm sim-input" placeholder="0.00">
                        </div>
                        <div class="col-4">
                            <label class="small text-muted">IPI %</label>
                            <input type="number" id="sim-ipi" class="form-control form-control-sm sim-input" placeholder="0">
                        </div>
                        <div class="col-4">
                            <label class="small text-muted">ICMS %</label>
                            <input type="number" id="sim-icms" class="form-control form-control-sm sim-input" value="12">
                        </div>
                        
                        <div class="col-2">
                            <label class="small text-muted" style="font-size: 0.7rem;">PIS %</label>
                            <input type="number" id="sim-pis" class="form-control form-control-sm sim-input" value="1.65">
                        </div>
                        <div class="col-2">
                            <label class="small text-muted" style="font-size: 0.7rem;">COFINS</label>
                            <input type="number" id="sim-cofins" class="form-control form-control-sm sim-input" value="7.60">
                        </div>
                    </div>
                    <div class="mt-2 text-end">
                        <small class="text-muted fst-italic">Custo calculado: <span id="sim-custo-display" class="fw-bold text-success">R$ 0,00</span></small>
                    </div>
                </div>

                <div class="row g-2 mb-3 pt-2 border-top">
                    <div class="col-6">
                        <label class="small fw-bold text-muted">Custo Final (R$)</label>
                        <input type="number" id="custo" class="form-control bg-readonly fw-bold" readonly>
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted">Peso (Kg)</label>
                        <input type="number" id="peso" class="form-control bg-readonly" readonly>
                    </div>
                </div>

                <h6 class="st-header mt-4">2. Configura칞칚o de Venda</h6>
                <div class="mb-3">
                    <label class="small fw-bold text-muted">Canal de Venda</label>
                    <select id="canal" class="form-select">
                        <option value="Mercado Livre">Mercado Livre</option>
                        <option value="Shopee">Shopee</option>
                        <option value="Site Pr칩prio">Site Pr칩prio</option>
                    </select>
                </div>

                <ul class="nav nav-tabs mb-3" id="modeTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-margem" data-bs-toggle="tab" data-mode="margem" type="button">Alvo: Margem</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-preco" data-bs-toggle="tab" data-mode="preco" type="button">Alvo: Pre칞o</button>
                    </li>
                </ul>

                <div class="row g-2 mb-3">
                    <div class="col-12" id="box-input-target">
                        <label class="small fw-bold text-primary" id="label-target">Margem Desejada (%)</label>
                        <input type="number" id="input-target" class="form-control border-primary fw-bold" value="15.0">
                    </div>
                    
                    <div class="col-6">
                        <label class="small text-muted">Comiss칚o (%)</label>
                        <input type="number" id="comissao" class="form-control" value="16.5">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">ICMS Sa칤da (%)</label>
                        <input type="number" id="icms" class="form-control" value="4.0">
                    </div>
                </div>

                <button onclick="calcularVenda()" class="btn btn-primary w-100 fw-bold py-2 mt-2">
                    <i class="fa-solid fa-bolt me-2"></i> CALCULAR PRE칂O
                </button>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="calc-card p-4 h-100 bg-white" id="result-box" style="opacity: 0.5; pointer-events: none;">
                
                <div class="text-center mb-4 border-bottom pb-4">
                    <small class="text-uppercase text-muted fw-bold ls-1" id="lbl-resultado-titulo">Pre칞o de Venda Sugerido</small>
                    <div class="display-3 fw-bold mt-2" id="lbl-resultado-valor">R$ 0,00</div>
                    
                    <div class="d-flex justify-content-center gap-3 mt-3">
                        <div class="badge bg-success fs-6 px-3 py-2 shadow-sm">
                            Lucro L칤quido: <span id="lbl-lucro">R$ 0,00</span>
                        </div>
                        <div class="badge bg-primary fs-6 px-3 py-2 shadow-sm">
                            Margem Real: <span id="lbl-margem-real">0%</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7 border-end">
                        <h6 class="st-header text-danger mb-3"><i class="fa-solid fa-list-ul me-2"></i> Detalhamento</h6>
                        
                        <div class="mb-3">
                            <small class="fw-bold text-muted text-uppercase" style="font-size: 0.7rem;">Impostos</small>
                            <div class="result-row text-secondary"><span>(-) ICMS:</span> <span class="result-val" id="res-icms">R$ 0,00</span></div>
                            <div class="result-row text-secondary"><span>(-) PIS/COFINS (9.25%):</span> <span class="result-val" id="res-pis-cofins">R$ 0,00</span></div>
                            <div class="result-row text-secondary" id="row-difal" style="display:none;"><span>(-) DIFAL:</span> <span class="result-val" id="res-difal">R$ 0,00</span></div>
                        </div>

                        <div class="mb-3">
                            <small class="fw-bold text-muted text-uppercase" style="font-size: 0.7rem;">Taxas</small>
                            <div class="result-row text-danger"><span>(-) Comiss칚o:</span> <span class="result-val" id="res-comissao">R$ 0,00</span></div>
                            <div class="result-row text-danger"><span>(-) Taxa Fixa:</span> <span class="result-val" id="res-taxa">R$ 0,00</span></div>
                            <div class="result-row text-danger"><span>(-) Frete / Envio:</span> <span class="result-val" id="res-frete">R$ 0,00</span></div>
                        </div>

                        <div class="result-row text-dark fw-bold border-top pt-2 mt-2" style="border-top: 2px solid #eee !important;">
                            <span>(-) Custo do Produto:</span> <span class="result-val" id="res-custo-prod">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="col-md-5 ps-md-4 d-flex flex-column justify-content-center">
                        <div class="alert alert-secondary border-0 mb-3">
                            <small class="d-block text-muted mb-1">Custo Total</small>
                            <strong class="fs-5 text-dark" id="res-custo-total">R$ 0,00</strong>
                        </div>
                        <div class="alert alert-success border-0 mb-0 shadow-sm">
                            <small class="d-block text-success mb-1 fw-bold">Receita L칤quida</small>
                            <strong class="fs-4 text-success" id="res-receita-liq">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // --- INICIALIZA칂츾O ---
        $('#selectProduto').select2({ theme: 'bootstrap-5', placeholder: 'Selecione um produto...' });
        let currentMode = 'db'; // 'db' ou 'sim'
        let calcTarget = 'margem'; // 'margem' ou 'preco'

        // --- L칍GICA DE CANAIS (TRAVA SHOPEE EM 20%) ---
        window.atualizarTaxasCanal = function() {
            let canal = $('#canal').val();
            let comissaoInput = $('#comissao');

            // 1. Reseta o estado (destrava o campo por padr칚o)
            comissaoInput.prop('readonly', false).removeClass('bg-secondary bg-opacity-10');

            if (canal === 'Shopee') {
                // REGRA: Fixa em 20% e bloqueia edi칞칚o (Fica cinza)
                comissaoInput.val(20.0);
                comissaoInput.prop('readonly', true).addClass('bg-secondary bg-opacity-10');
            } 
            else if (canal === 'Mercado Livre') {
                comissaoInput.val(16.5); // Sugest칚o inicial
            } 
            else {
                comissaoInput.val(0.0); // Site Pr칩prio
            }
        };

        // Ativa a fun칞칚o sempre que mudar o Canal no select
        $('#canal').on('change', window.atualizarTaxasCanal);


        // --- L칍GICA DE TOGGLE (DB vs SIMULA칂츾O) ---
        window.toggleMode = function(mode) {
            currentMode = mode;
            if(mode === 'db') {
                $('#container-db').show();
                $('#container-sim').hide();
                
                $('#custo').addClass('bg-readonly').prop('readonly', true);
                $('#peso').addClass('bg-readonly').prop('readonly', true);
                
                $('#custo').val('');
                $('#peso').val('');
            } else {
                $('#container-db').hide();
                $('#container-sim').show();
                
                $('#peso').removeClass('bg-readonly').prop('readonly', false).val(0.5);
                $('#custo').val(0);
                
                // For칞a recalculo inicial
                recalcularCustoSimulado();
            }
        };

        // --- L칍GICA DE IMPORTA칂츾O (Atualiza Taxas) ---
        window.atualizarTaxasSimulacao = function() {
            let isImport = $('#sim-importacao').is(':checked');
            if(isImport) {
                $('#sim-pis').val(2.10);
                $('#sim-cofins').val(9.65);
            } else {
                $('#sim-pis').val(1.65);
                $('#sim-cofins').val(7.60);
            }
            // Recalcula o custo ap칩s mudar as taxas
            recalcularCustoSimulado();
        }

        // --- C츼LCULO DE CUSTO NA SIMULA칂츾O (API) ---
        function recalcularCustoSimulado() {
            if(currentMode !== 'sim') return;

            let payload = {
                preco_nota: parseFloat($('#sim-preco').val()) || 0,
                frete: parseFloat($('#sim-frete').val()) || 0,
                ipi: parseFloat($('#sim-ipi').val()) || 0,
                icms: parseFloat($('#sim-icms').val()) || 0,
                // Agora enviamos PIS e COFINS exatos
                pis: parseFloat($('#sim-pis').val()) || 0, 
                cofins: parseFloat($('#sim-cofins').val()) || 0,
                lucro_real: $('#sim-lucro-real').is(':checked')
            };

            fetch('/api/simular_custo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                $('#custo').val(data.custo_final.toFixed(4));
                $('#sim-custo-display').text('R$ ' + data.custo_final.toFixed(2));
            });
        }

        // Listener nos inputs de simula칞칚o
        $('.sim-input').on('input change', recalcularCustoSimulado);

        // --- BUSCA PRODUTO (MODO DB) ---
        $('#selectProduto').on('select2:select', function(e) {
            if(currentMode !== 'db') return;
            let id = $(this).val();
            
            fetch(`/api/produto/${id}`)
                .then(response => response.json())
                .then(data => {
                    if(data.error) { alert('Erro'); return; }
                    $('#custo').val(data.custo.toFixed(4));
                    $('#peso').val(data.peso);
                    calcularVenda();
                });
        });

        // --- ABAS ALVO (MARGEM vs PRE칂O) ---
        $('.nav-link').click(function() {
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            calcTarget = $(this).data('mode');
            
            if (calcTarget === 'margem') {
                $('#label-target').text('Margem Desejada (%)');
                $('#input-target').attr('placeholder', 'Ex: 15.0');
                $('#lbl-resultado-titulo').text('Pre칞o de Venda Sugerido');
            } else {
                $('#label-target').text('Pre칞o de Venda Manual (R$)');
                $('#input-target').attr('placeholder', 'Ex: 159.90');
                $('#lbl-resultado-titulo').text('Margem Resultante');
            }
        });

        // --- C츼LCULO FINAL DE VENDA ---
        window.calcularVenda = function() {
            let custo = parseFloat($('#custo').val());
            if (isNaN(custo) || custo <= 0) { 
                if(currentMode === 'sim') alert('Preencha os dados da compra para gerar um custo!');
                else alert('Selecione um produto!'); 
                return; 
            }

            let payload = {
                custo: custo,
                peso: $('#peso').val(),
                canal: $('#canal').val(),
                comissao: $('#comissao').val(),
                icms: $('#icms').val(),
                modo: calcTarget
            };

            if (calcTarget === 'margem') payload.margem = $('#input-target').val();
            else payload.preco_manual = $('#input-target').val();

            $('#result-box').css({'opacity': '1', 'pointer-events': 'all'});

            fetch('/api/calcular', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
                
                // Labels
                if (calcTarget === 'margem') {
                    $('#lbl-resultado-valor').text(fmt.format(data.preco));
                } else {
                     $('#lbl-resultado-valor').text(data.margem.toFixed(2) + '%');
                     $('#lbl-resultado-titulo').text('Margem de Lucro Real');
                }
                
                $('#lbl-lucro').text(fmt.format(data.lucro));
                $('#lbl-margem-real').text(data.margem.toFixed(2) + '%');

                // Detalhes
                $('#res-icms').text(fmt.format(data.val_icms));
                $('#res-pis-cofins').text(fmt.format(data.val_pis_cofins));
                
                if(data.val_difal > 0) {
                    $('#row-difal').show();
                    $('#res-difal').text(fmt.format(data.val_difal));
                } else { $('#row-difal').hide(); }

                $('#res-comissao').text(fmt.format(data.val_comissao));
                $('#res-frete').text(fmt.format(data.frete));
                $('#res-taxa').text(fmt.format(data.taxa_fixa));
                $('#res-custo-prod').text(fmt.format(data.custo));

                // Totais
                let totalImpostos = data.val_imposto_total; 
                let totalTaxas = data.val_comissao + data.frete + data.taxa_fixa;
                let custoTotal = totalImpostos + totalTaxas + data.custo;
                let receitaLiq = data.preco - totalImpostos - totalTaxas;

                $('#res-custo-total').text(fmt.format(custoTotal));
                $('#res-receita-liq').text(fmt.format(receitaLiq));
            })
            .catch(err => console.error(err));
        };
    });
</script>

{% endblock %}
