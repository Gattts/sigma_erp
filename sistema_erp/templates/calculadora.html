{% extends "base.html" %} {% block content %}

<div class="container-fluid py-2">
  <div class="d-flex align-items-center mb-3 ms-2">
    <h4 class="fw-bold m-0 me-4">
      <i class="fa-solid fa-calculator me-2"></i> Precifica칞칚o
    </h4>
    <ul class="nav nav-pills" id="pills-tab" role="tablist">
      <li class="nav-item">
        <button
          class="nav-link active fw-bold small"
          id="pills-calc-tab"
          data-bs-toggle="pill"
          data-bs-target="#pills-calc"
          type="button"
        >
          Calculadora
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link fw-bold small text-adaptive"
          id="pills-hist-tab"
          data-bs-toggle="pill"
          data-bs-target="#pills-hist"
          type="button"
        >
          Pre칞os Salvos
        </button>
      </li>
    </ul>
  </div>

  <div class="tab-content" id="pills-tabContent">
    <div class="tab-pane fade show active" id="pills-calc">
      <div class="row g-3">
        <div class="col-lg-5">
          <div class="calc-card p-4 card-scroll h-100">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <label class="small fw-bold text-muted mb-0"
                ><i class="fa-solid fa-box me-1"></i> Sele칞칚o de Produto</label
              >
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="toggle-simulacao"
                />
                <label
                  class="form-check-label small fw-bold text-success"
                  for="toggle-simulacao"
                  >Simular Compra</label
                >
              </div>
            </div>

            <div class="mb-4">
              <select id="selectProduto" class="form-select">
                <option value="">Selecione um produto do estoque...</option>
                {% for p in produtos %}
                <option value="{{ p.id }}">{{ p.sku }} - {{ p.nome }}</option>
                {% endfor %}
              </select>
              <div
                id="info-simulacao"
                class="text-end mt-1"
                style="display: none"
              >
                <small class="text-success fst-italic"
                  ><i class="fa-solid fa-flask me-1"></i> Modo Simula칞칚o Ativo.
                  <a href="#" onclick="abrirModalSimulacao()"
                    >Editar valores</a
                  ></small
                >
              </div>
            </div>

            <div class="p-3 bg-light rounded border mb-4">
              <div class="row g-2">
                <div class="col-6">
                  <div
                    class="d-flex justify-content-between align-items-center mb-1"
                  >
                    <label class="small fw-bold text-muted mb-0"
                      >Custo Final</label
                    >
                    <button
                      type="button"
                      class="btn btn-sm btn-link text-decoration-none p-0"
                      onclick="verHistorico()"
                      id="btn-historico"
                      style="font-size: 0.7rem"
                    >
                      <i class="fa-solid fa-clock-rotate-left"></i> Hist칩rico
                    </button>
                  </div>
                  <div class="input-group input-group-sm">
                    <span
                      class="input-group-text border-0 bg-transparent fw-bold text-muted"
                      >R$</span
                    >
                    <input
                      type="number"
                      id="custo"
                      class="form-control fw-bold bg-transparent border-0 fs-5 text-dark p-0"
                      readonly
                      placeholder="0.00"
                    />
                  </div>
                </div>
                <div class="col-6 border-start ps-3">
                  <label class="small fw-bold text-muted mb-1">Peso (Kg)</label>
                  <input
                    type="number"
                    id="peso"
                    class="form-control fw-bold bg-transparent border-0 fs-5 text-dark p-0"
                    readonly
                    placeholder="0.000"
                  />
                </div>
              </div>
            </div>

            <h6 class="st-header">Configura칞칚o de Venda</h6>

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="small text-muted">Regime Tribut치rio</label>
                <select
                  id="regime"
                  class="form-select form-select-sm"
                  onchange="atualizarUIPorRegime()"
                >
                  <option value="Lucro Real" selected>Lucro Real</option>
                  <option value="Simples Nacional">Simples Nacional</option>
                  <option value="TTD 478">TTD 478 (SC)</option>
                  <option value="CPF">Pessoa F칤sica</option>
                </select>
              </div>
              <div class="col-6">
                <label class="small text-muted">Canal</label>
                <select id="canal" class="form-select form-select-sm">
                  <option value="Mercado Livre">Mercado Livre</option>
                  <option value="Shopee">Shopee</option>
                  <option value="Site Pr칩prio">Site Pr칩prio</option>
                </select>
              </div>
            </div>

            <div
              class="d-flex gap-3 mb-3 p-2 bg-white border rounded justify-content-center"
            >
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="check-queima"
                />
                <label
                  class="form-check-label small fw-bold text-danger"
                  for="check-queima"
                  >游댠 Queima</label
                >
              </div>
              <div class="vr opacity-25"></div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="check-full"
                />
                <label
                  class="form-check-label small fw-bold text-warning"
                  for="check-full"
                  ><i class="fa-solid fa-bolt me-1"></i> Full</label
                >
              </div>
            </div>

            <ul
              class="nav nav-tabs nav-fill mb-3 small"
              id="modeTab"
              role="tablist"
            >
              <li class="nav-item">
                <button
                  class="nav-link active py-1"
                  id="tab-margem"
                  data-bs-toggle="tab"
                  data-mode="margem"
                  type="button"
                >
                  Alvo: Margem
                </button>
              </li>
              <li class="nav-item">
                <button
                  class="nav-link py-1"
                  id="tab-preco"
                  data-bs-toggle="tab"
                  data-mode="preco"
                  type="button"
                >
                  Alvo: Pre칞o
                </button>
              </li>
            </ul>

            <div class="row g-2 mb-3">
              <div class="col-12" id="box-input-target">
                <label class="small fw-bold text-primary" id="label-target"
                  >Margem Desejada (%)</label
                >
                <input
                  type="number"
                  id="input-target"
                  class="form-control border-primary fw-bold"
                  value="15.0"
                />
              </div>
              <div class="col-4">
                <label class="small text-muted">Comiss칚o (%)</label
                ><input
                  type="number"
                  id="comissao"
                  class="form-control form-control-sm"
                  value="16.5"
                />
              </div>
              <div class="col-4">
                <label class="small text-muted text-warning fw-bold"
                  >Log칤stica (%)</label
                ><input
                  type="number"
                  id="logistica"
                  class="form-control form-control-sm"
                  value="0"
                  placeholder="Ex: 5"
                />
              </div>
              <div class="col-4">
                <label class="small text-muted" id="lbl-icms"
                  >ICMS Sa칤da (%)</label
                ><input
                  type="number"
                  id="icms"
                  class="form-control form-control-sm"
                  value="4.0"
                />
              </div>
              <div class="col-12">
                <label class="small text-muted text-danger"
                  >DIFAL (%)
                  <span
                    class="badge bg-light text-dark border ms-1"
                    style="font-size: 0.6em"
                    >MANUAL</span
                  ></label
                ><input
                  type="number"
                  id="difal"
                  class="form-control form-control-sm"
                  value="0"
                  placeholder="0"
                />
              </div>
            </div>

            <button
              onclick="calcularVenda()"
              class="btn btn-primary w-100 fw-bold py-2 mt-auto"
            >
              <i class="fa-solid fa-bolt me-2"></i> CALCULAR
            </button>
          </div>
        </div>

        <div class="col-lg-7">
          <div
            class="calc-card p-4 bg-white card-scroll h-100"
            id="result-box"
            style="opacity: 0.5; pointer-events: none"
          >
            <div class="text-center mb-4 border-bottom pb-4">
              <small
                class="text-uppercase text-muted fw-bold ls-1 mb-2 d-block text-primary"
                ><i class="fa-solid fa-file-invoice-dollar me-1"></i> Resumo da
                Venda</small
              >

              <div
                class="display-3 fw-bold mt-2 text-dark"
                id="lbl-resultado-valor"
              >
                R$ 0,00
              </div>

              <div
                class="d-flex flex-wrap justify-content-center gap-2 mt-4 align-items-center"
              >
                <div
                  class="badge bg-success fs-6 py-2 px-3 shadow-sm fw-normal d-flex align-items-center"
                  title="Lucro L칤quido"
                >
                  Lucro:
                  <span id="lbl-lucro" class="fw-bold ms-1">R$ 0,00</span>
                </div>
                <div
                  class="badge bg-primary fs-6 py-2 px-3 shadow-sm fw-normal d-flex align-items-center"
                  title="Margem Real"
                >
                  Margem:
                  <span id="lbl-margem-real" class="fw-bold ms-1">0%</span>
                </div>

                <div
                  id="badge-full-res"
                  class="badge bg-warning text-dark fs-6 py-2 px-3 shadow-sm fw-bold border border-warning d-none align-items-center"
                >
                  <i class="fa-solid fa-bolt me-1"></i> FULL
                </div>
                <div
                  id="badge-queima-res"
                  class="badge bg-danger fs-6 py-2 px-3 shadow-sm fw-bold border border-danger d-none align-items-center"
                >
                  <i class="fa-solid fa-fire me-1"></i> QUEIMA
                </div>

                <button
                  onclick="salvarCalculo()"
                  class="btn btn-outline-success fw-bold rounded-pill shadow-sm d-flex align-items-center py-1 px-3"
                  style="border-width: 2px; height: 32px"
                  title="Salvar no Hist칩rico"
                >
                  <i class="fa-solid fa-floppy-disk me-2"></i> Salvar
                </button>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-md-6">
                <h6 class="text-danger small fw-bold border-bottom pb-2 mb-3">
                  Custos & Taxas
                </h6>
                <div class="d-flex justify-content-between small mb-2">
                  <span>Produto (Custo):</span
                  ><span class="fw-bold" id="res-custo-prod">R$ 0,00</span>
                </div>
                <div
                  class="d-flex justify-content-between small mb-1 text-danger"
                >
                  <span>Comiss칚o:</span><span id="res-comissao">R$ 0,00</span>
                </div>
                <div
                  class="d-flex justify-content-between small mb-1 text-danger"
                >
                  <span>Taxa Fixa:</span><span id="res-taxa">R$ 0,00</span>
                </div>
                <div
                  class="d-flex justify-content-between small mb-1 text-danger"
                >
                  <span>Frete:</span><span id="res-frete">R$ 0,00</span>
                </div>
                <div
                  class="d-flex justify-content-between small mb-1 text-warning"
                >
                  <span>Log칤stica:</span><span id="res-logistica">R$ 0,00</span>
                </div>
              </div>
              <div class="col-md-6">
                <h6
                  class="text-secondary small fw-bold border-bottom pb-2 mb-3"
                >
                  Impostos
                </h6>
                <div class="d-flex justify-content-between small mb-2">
                  <span>ICMS:</span><span id="res-icms">R$ 0,00</span>
                </div>
                <div id="box-pis-cofins">
                  <div
                    class="d-flex justify-content-between small mb-1 text-secondary"
                  >
                    <span>PIS:</span><span id="res-pis">R$ 0,00</span>
                  </div>
                  <div
                    class="d-flex justify-content-between small mb-1 text-secondary"
                  >
                    <span>COFINS:</span><span id="res-cofins">R$ 0,00</span>
                  </div>
                </div>
                <div
                  class="d-flex justify-content-between small mb-1 text-danger fw-bold"
                  id="row-difal"
                  style="display: none"
                >
                  <span>DIFAL:</span><span id="res-difal">R$ 0,00</span>
                </div>
              </div>
            </div>

            <div class="row g-2 mt-4">
              <div class="col-6">
                <div class="p-3 rounded border bg-light text-center">
                  <small
                    class="text-muted d-block text-uppercase fw-bold"
                    style="font-size: 0.65rem"
                    >Repasse Marketplace</small
                  >
                  <div
                    class="fw-bold fs-5 text-secondary mt-1"
                    id="res-repasse-mkt"
                  >
                    R$ 0,00
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div
                  class="p-3 rounded border bg-success bg-opacity-10 border-success text-center"
                >
                  <small
                    class="text-success d-block text-uppercase fw-bold"
                    style="font-size: 0.65rem"
                    >Repasse Final (Real)</small
                  >
                  <div
                    class="fw-bold fs-5 text-success mt-1"
                    id="res-repasse-final"
                  >
                    R$ 0,00
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pills-hist" role="tabpanel">
      <div class="calc-card p-4 bg-white card-scroll">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold text-adaptive m-0">
            <i class="fa-solid fa-list-check me-2"></i> Tabela de Pre칞os Salvos
          </h5>
          <button
            class="btn btn-sm btn-outline-secondary"
            onclick="window.location.reload()"
          >
            <i class="fa-solid fa-rotate me-1"></i> Atualizar
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle small">
            <thead class="bg-light">
              <tr>
                <th class="ps-3">Data</th>
                <th>Produto</th>
                <th>Canal</th>
                <th class="text-center">Custo</th>
                <th class="text-end">Pre칞o</th>
                <th class="text-center">Margem</th>
                <th class="text-end pe-3">Lucro</th>
              </tr>
            </thead>
            <tbody>
              {% for h in historico_precos %}
              <tr class="{{ 'bg-danger bg-opacity-10' if h.queima else '' }}">
                <td class="text-muted ps-3">{{ h.data_registro }}</td>
                <td>
                  <div class="fw-bold text-truncate" style="max-width: 200px">
                    {{ h.nome }}
                  </div>
                  <span class="badge bg-light text-dark border"
                    >{{ h.sku }}</span
                  >
                </td>
                <td>{{ h.canal }}</td>
                <td class="text-center">
                  R$ {{ "%.2f"|format(h.custo_base) }}
                </td>
                <td class="text-end fw-bold text-primary">
                  R$ {{ "%.2f"|format(h.preco_venda) }}
                </td>
                <td class="text-center">{{ h.margem_real }}%</td>
                <td class="text-end fw-bold text-success pe-3">
                  R$ {{ "%.2f"|format(h.lucro_liquido) }}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="7" class="text-center py-5 text-muted">
                  Nenhum registro.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="modalSimulacao"
  tabindex="-1"
  data-bs-backdrop="static"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h6 class="modal-title fw-bold">
          <i class="fa-solid fa-flask me-2"></i> Simular Custo de Compra
        </h6>
        <button
          type="button"
          class="btn-close btn-close-white"
          onclick="fecharModalSimulacao()"
        ></button>
      </div>
      <div class="modal-body">
        <div
          class="alert alert-light border border-success border-opacity-25 small text-muted mb-3"
        >
          <i class="fa-solid fa-info-circle me-1"></i> Preencha os dados abaixo
          para estimar o custo.
        </div>
        <div class="d-flex justify-content-between mb-3 bg-light p-2 rounded">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="sim-lucro-real"
              checked
            />
            <label class="form-check-label small fw-bold" for="sim-lucro-real"
              >Lucro Real</label
            >
          </div>
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="sim-importacao"
              onchange="atualizarTaxasSimulacao()"
            />
            <label
              class="form-check-label small fw-bold text-primary"
              for="sim-importacao"
              >Importa칞칚o Pr칩pria</label
            >
          </div>
        </div>
        <div class="row g-3">
          <div class="col-6">
            <label class="small fw-bold text-muted">Pre칞o Nota (R$)</label
            ><input
              type="number"
              id="sim-preco"
              class="form-control fw-bold"
              placeholder="0.00"
            />
          </div>
          <div class="col-6">
            <label class="small fw-bold text-muted">Frete (R$)</label
            ><input
              type="number"
              id="sim-frete"
              class="form-control"
              placeholder="0.00"
            />
          </div>
          <div class="col-3">
            <label class="small text-muted">IPI %</label
            ><input
              type="number"
              id="sim-ipi"
              class="form-control"
              placeholder="0"
            />
          </div>
          <div class="col-3">
            <label class="small text-muted">ICMS %</label
            ><input
              type="number"
              id="sim-icms"
              class="form-control"
              value="12"
            />
          </div>
          <div class="col-3">
            <label class="small text-muted">PIS %</label
            ><input
              type="number"
              id="sim-pis"
              class="form-control bg-light"
              value="1.65"
              readonly
            />
          </div>
          <div class="col-3">
            <label class="small text-muted">COFINS</label
            ><input
              type="number"
              id="sim-cofins"
              class="form-control bg-light"
              value="7.60"
              readonly
            />
          </div>
          <div class="col-12">
            <label class="small fw-bold text-muted">Peso Estimado (Kg)</label
            ><input
              type="number"
              id="sim-peso"
              class="form-control"
              value="0.5"
            />
          </div>
        </div>
      </div>
      <div
        class="modal-footer bg-light d-flex justify-content-between align-items-center"
      >
        <div>
          <small class="text-muted d-block" style="font-size: 0.75rem"
            >CUSTO FINAL ESTIMADO</small
          >
          <span id="lbl-custo-simulado" class="fw-bold text-success fs-5"
            >R$ 0,00</span
          >
        </div>
        <button
          type="button"
          class="btn btn-success fw-bold px-4"
          onclick="confirmarSimulacao()"
        >
          <i class="fa-solid fa-check me-2"></i> Usar Este Custo
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalHistorico" tabindex="-1">
  <div
    class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"
  >
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-panel border-bottom">
        <h5 class="modal-title fw-bold" id="modalTitulo">Hist칩rico</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body p-0">
        <div class="table-responsive">
          <table
            class="table table-hover align-middle mb-0"
            id="tabelaHistorico"
            style="font-size: 0.9rem"
          >
            <thead class="bg-light">
              <tr>
                <th class="ps-4">Data</th>
                <th>Fornecedor</th>
                <th class="text-center">Qtd</th>
                <th class="text-end">Pre칞o NF</th>
                <th class="text-end pe-4">Custo Final</th>
              </tr>
            </thead>
            <tbody id="corpoTabelaHistorico"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div
    id="liveToast"
    class="toast align-items-center text-white bg-success border-0"
    role="alert"
  >
    <div class="d-flex">
      <div class="toast-body fw-bold" id="toast-msg">Sucesso!</div>
      <button
        type="button"
        class="btn-close btn-close-white me-2 m-auto"
        data-bs-dismiss="toast"
      ></button>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  $(document).ready(function () {
    $("#selectProduto").select2({
      theme: "bootstrap-5",
      placeholder: "Selecione um produto...",
    });
    let origemGlobal = "0";
    let modoSimulacao = false;
    let calcTarget = "margem";
    let lastCalculatedData = null;

    function parseLocalNum(val) {
      if (!val) return 0.0;
      if (typeof val === "string") val = val.replace(",", ".");
      return parseFloat(val) || 0.0;
    }

    $("#toggle-simulacao").change(function () {
      if (this.checked) {
        modoSimulacao = true;
        $("#selectProduto").prop("disabled", true);
        $("#btn-historico").hide();
        $("#info-simulacao").show();
        abrirModalSimulacao();
      } else {
        modoSimulacao = false;
        $("#selectProduto").prop("disabled", false);
        $("#btn-historico").show();
        $("#info-simulacao").hide();
        $("#custo").val("");
        $("#peso").val("");
        $("#selectProduto").val("").trigger("change");
      }
    });

    window.abrirModalSimulacao = function () {
      var modal = new bootstrap.Modal(
        document.getElementById("modalSimulacao")
      );
      modal.show();
    };

    window.fecharModalSimulacao = function () {
      if ($("#toggle-simulacao").is(":checked") && $("#custo").val() === "") {
        $("#toggle-simulacao").prop("checked", false).trigger("change");
      }
      bootstrap.Modal.getInstance(
        document.getElementById("modalSimulacao")
      ).hide();
    };

    $("#sim-preco, #sim-frete, #sim-ipi, #sim-icms").on("input", function () {
      let payload = {
        preco_nota: parseLocalNum($("#sim-preco").val()),
        frete: parseLocalNum($("#sim-frete").val()),
        ipi: parseLocalNum($("#sim-ipi").val()),
        icms: parseLocalNum($("#sim-icms").val()),
        pis: parseLocalNum($("#sim-pis").val()),
        cofins: parseLocalNum($("#sim-cofins").val()),
        regime: $("#sim-lucro-real").is(":checked") ? "Lucro Real" : "Simples",
      };
      fetch("/api/simular_custo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((res) => res.json())
        .then((data) => {
          $("#lbl-custo-simulado").text("R$ " + data.custo_final.toFixed(2));
          $("#custo").data("simulado", data.custo_final);
        });
    });

    window.confirmarSimulacao = function () {
      let custoSim = $("#custo").data("simulado") || 0;
      let pesoSim = $("#sim-peso").val();
      $("#custo").val(custoSim.toFixed(4));
      $("#peso").val(pesoSim);
      bootstrap.Modal.getInstance(
        document.getElementById("modalSimulacao")
      ).hide();
      calcularVenda();
    };

    window.atualizarTaxasSimulacao = function () {
      if ($("#sim-importacao").is(":checked")) {
        $("#sim-pis").val(2.1);
        $("#sim-cofins").val(9.65);
      } else {
        $("#sim-pis").val(1.65);
        $("#sim-cofins").val(7.6);
      }
      $("#sim-preco").trigger("input");
    };

    $("#selectProduto").on("select2:select", function (e) {
      if (modoSimulacao) return;
      let id = $(this).val();
      fetch(`/api/produto/${id}`)
        .then((res) => res.json())
        .then((data) => {
          $("#custo").val(data.custo.toFixed(4));
          $("#peso").val(data.peso);
          origemGlobal = String(data.origem || "0");
          atualizarUIPorRegime();
          calcularVenda();
        });
    });

    $(".nav-link").click(function () {
      $(".nav-link").removeClass("active");
      $(this).addClass("active");
      calcTarget = $(this).data("mode");
      if (calcTarget === "margem") {
        $("#label-target").text("Margem Desejada (%)");
        $("#lbl-resultado-titulo").text("Pre칞o de Venda Sugerido");
      } else {
        $("#label-target").text("Pre칞o de Venda Manual (R$)");
        $("#lbl-resultado-titulo").text("Margem Resultante");
      }
    });

    window.atualizarUIPorRegime = function () {
      let regime = $("#regime").val();
      let icmsInput = $("#icms");
      let difalInput = $("#difal");
      let lblIcms = $("#lbl-icms");
      icmsInput.prop("disabled", false);
      difalInput.prop("disabled", false);

      if (regime === "CPF") {
        icmsInput.val(0).prop("disabled", true);
        difalInput.val(0).prop("disabled", true);
        lblIcms.text("ICMS (Isento)");
      } else if (regime === "Simples Nacional") {
        lblIcms.text("Al칤quota Simples (%)");
        difalInput.prop("disabled", true).val(0);
      } else if (regime === "TTD 478") {
        lblIcms.text("ICMS (Travado TTD)");
        icmsInput.prop("disabled", true);
        let origem = modoSimulacao
          ? $("#sim-importacao").is(":checked")
            ? "1"
            : "0"
          : origemGlobal;
        let cod = origem.trim().charAt(0);
        if (["1", "2", "3", "5", "8"].includes(cod)) icmsInput.val(1.0);
        else icmsInput.val(2.0);
      } else {
        lblIcms.text("ICMS Sa칤da (%)");
        if ([0, 1, 2].includes(parseLocalNum(icmsInput.val())))
          icmsInput.val(4.0);
      }
    };

    $("#regime").on("change", function () {
      atualizarUIPorRegime();
      calcularVenda();
    });
    $("#canal").on("change", window.atualizarTaxasCanal);

    window.atualizarTaxasCanal = function () {
      let canal = $("#canal").val();
      let input = $("#comissao");
      input.prop("readonly", false).removeClass("bg-secondary bg-opacity-10");
      if (canal === "Shopee")
        input
          .val(20.0)
          .prop("readonly", true)
          .addClass("bg-secondary bg-opacity-10");
      else if (canal === "Mercado Livre") input.val(16.5);
      else input.val(0.0);
    };

    window.calcularVenda = function () {
      let custo = parseLocalNum($("#custo").val());
      if (custo <= 0) return;

      let origem = modoSimulacao
        ? $("#sim-importacao").is(":checked")
          ? "1"
          : "0"
        : origemGlobal;
      let isQueima = $("#check-queima").is(":checked");
      let isFull = $("#check-full").is(":checked");

      let payload = {
        custo: custo,
        peso: parseLocalNum($("#peso").val()),
        canal: $("#canal").val(),
        comissao: parseLocalNum($("#comissao").val()),
        icms: parseLocalNum($("#icms").val()),
        difal: parseLocalNum($("#difal").val()),
        modo: calcTarget,
        regime: $("#regime").val(),
        logistica_pct: parseLocalNum($("#logistica").val()),
        origem_produto: origem,
        is_full: isFull,
      };

      if (calcTarget === "margem")
        payload.margem = parseLocalNum($("#input-target").val());
      else payload.preco_manual = parseLocalNum($("#input-target").val());

      $("#result-box").css({ opacity: "1", "pointer-events": "all" });

      fetch("/api/calcular", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((res) => res.json())
        .then((data) => {
          lastCalculatedData = data;
          const fmt = new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL",
          });

          if (calcTarget === "margem")
            $("#lbl-resultado-valor").text(fmt.format(data.preco));
          else $("#lbl-resultado-valor").text(data.margem.toFixed(2) + "%");

          $("#lbl-lucro").text(fmt.format(data.lucro));
          $("#lbl-margem-real").text(data.margem.toFixed(2) + "%");
          $("#res-icms").text(fmt.format(data.val_icms));

          if (
            $("#regime").val() === "CPF" ||
            $("#regime").val() === "Simples Nacional"
          )
            $("#box-pis-cofins").hide();
          else {
            $("#box-pis-cofins").show();
            $("#res-pis").text(fmt.format(data.val_pis));
            $("#res-cofins").text(fmt.format(data.val_cofins));
          }

          if (data.val_difal > 0) {
            $("#row-difal")
              .show()
              .find("span:last")
              .text(fmt.format(data.val_difal));
          } else $("#row-difal").hide();

          $("#res-comissao").text(fmt.format(data.val_comissao));
          $("#res-logistica").text(fmt.format(data.val_logistica));
          $("#res-frete").text(fmt.format(data.frete));
          $("#res-taxa").text(fmt.format(data.taxa_fixa));
          $("#res-custo-prod").text(fmt.format(data.custo));

          // C츼LCULO DOS REPASSES (NOVO)
          // 1. Repasse Marketplace (O que cai na conta) = Pre칞o - (Comiss칚o + Frete + Taxa Fixa + Log칤stica)
          let repasseMkt =
            data.preco -
            (data.val_comissao +
              data.frete +
              data.taxa_fixa +
              data.val_logistica);

          // 2. Repasse Final (O que sobra pra voc칡) = Repasse Mkt - Impostos (ICMS + PIS + COFINS + DIFAL)
          // data.val_imposto_total j치 soma todos os impostos
          let repasseFinal = repasseMkt - data.val_imposto_total;

          // Exibe na tela
          $("#res-repasse-mkt").text(fmt.format(repasseMkt));
          $("#res-repasse-final").text(fmt.format(repasseFinal));

          // BADGES DE AVISO (VISUAL)
          if (isQueima) $("#badge-queima-res").removeClass("d-none");
          else $("#badge-queima-res").addClass("d-none");
          if (isFull) $("#badge-full-res").removeClass("d-none");
          else $("#badge-full-res").addClass("d-none");
        })
        .catch((err) => console.error(err));
    };

    window.salvarCalculo = function () {
      if (!lastCalculatedData) {
        alert("Realize um c치lculo primeiro!");
        return;
      }

      let payload = {
        produto_id: modoSimulacao ? null : $("#selectProduto").val(),
        canal: $("#canal").val(),
        custo: lastCalculatedData.custo,
        preco:
          calcTarget === "margem"
            ? lastCalculatedData.preco
            : parseLocalNum($("#input-target").val()),
        margem: lastCalculatedData.margem,
        lucro: lastCalculatedData.lucro,
        queima: $("#check-queima").is(":checked"),
      };

      if (!payload.produto_id) {
        alert("Aten칞칚o: Apenas produtos cadastrados s칚o salvos no hist칩rico.");
        return;
      }

      fetch("/api/salvar_calculo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            let toastEl = document.getElementById("liveToast");
            new bootstrap.Toast(toastEl).show();
            setTimeout(() => window.location.reload(), 1000);
          } else {
            alert("Erro: " + data.message);
          }
        });
    };

    window.verHistorico = function () {
      let id = $("#selectProduto").val();
      var modal = new bootstrap.Modal(
        document.getElementById("modalHistorico")
      );
      modal.show();
      $("#corpoTabelaHistorico").html(
        '<tr><td colspan="5" class="text-center">Carregando...</td></tr>'
      );

      fetch(`/api/historico_compras_calc/${id}`)
        .then((res) => res.json())
        .then((data) => {
          let html = "";
          if (data.length === 0)
            html =
              '<tr><td colspan="5" class="text-center text-muted">Sem hist칩rico.</td></tr>';
          else {
            data.forEach((i) => {
              html += `<tr><td class="ps-4">${i.data_emissao}</td><td>${
                i.fornecedor
              }</td><td class="text-center">${
                i.quantidade
              }</td><td class="text-end">R$ ${i.preco_partida.toFixed(
                2
              )}</td><td class="text-end pe-4 fw-bold text-success">R$ ${i.custo_final.toFixed(
                2
              )}</td></tr>`;
            });
          }
          $("#corpoTabelaHistorico").html(html);
        });
    };
  });
</script>
{% endblock %}
